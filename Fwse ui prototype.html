<html>
        <head>
                <title>Fwse Prototype</title>
                <script type="text/javascript" src="jquery-1.4.1.js"></script>
                        <link type="text/css" href="css/ui-lightness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />
                        <!--script type="text/javascript" src="js/jquery-1.3.2.min.js"></script-->
                        <!--script type="text/javascript" src="http://jquery-ui.googlecode.com/svn/tags/1.8rc1/jquery-1.4.1.js"></script-->
                        <script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>


                        <style type="text/css">
                                #tree input {
                                        color: black;
                                        background-color: #ddddff;
                                        border: none;
                                        font-style: none;
                                        font-size: none;
                                        padding-left:3px;
                                        padding-right:3px;
                                        padding-top: 0px;
                                        padding-bottom: 0px;
                                        width: 100%;
                                }
                                body {
                                        margin-left: 5cm;
                                }
                                #tree {
                                        margin-left: 14px;
                                }
                                #tree ul {
                                        margin-left: 34px;
                                }
                                #tree, #tree ul {
                                        border-left: 1px solid #eeeeee;
                                        padding-left: 6px;
                                }
                                span.subject {
                                        padding-left:3px;
                                        padding-right:3px;
                                }
                                #tree li {
                                        background-color: white;
                                        list-style-type: none;
                                        font-style: normal;
                                        font-size: small;
                                        width: 100%;
                                }
                                #selected > span.subject {
                                        // font-weight: bold;
                                        background-color: #ffffaa;
                                }
                                ul {
                                        background-color: white;
                                        font-weight: normal;
                                }
                                div#output {
                                        font-size: x-small;
                                }
                                div#output.hidden {
                                        display: none;
                                }
                                .headline > span.subject, .headline > input {
                                        font-style: italic;
                                }
                                .section > span.subject, .section > input {
                                        font-size: x-large;
                                }
                                .subsection > span.subject, .subsection > input {
                                        font-size: large;
                                }
                                .subsubsection > span.subject, .subsubsection > input {
                                        font-size: medium;
                                }
                                div.body {
                                        display: none;
                                }
                                #editDialog textarea {
                                        width: 100%;
                                        height: 100%;
                                }
                        </style>
                <script language="javascript">

                        var parameters;
                        $(function() {
                            var x = $('li').first();
                            x.attr('id', 'selected');
                            adjustSectioning($('ul#tree li'));
                            $('#editDialog').dialog({ 
                                    'modal': true,
                                    'autoOpen': false,
                                    'close': function() {
                                        editing = false;
                                    },
                                    'open': function() {
                                        $(this).children('textarea').focus();
                                    },
                                    'height': '50%',
                                    'width': '50%'
                            });
                            parameters = [];
                            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                            for(var i = 0; i < hashes.length; i++)
                            {
                                var hash = hashes[i].split('=');
                                parameters.push(hash[0]);
                                parameters[hash[0]] = hash[1];
                            }
                            if( !parameters['filename'] )
                                alert("Reload page with a filename as get parameter (...html?filename=/hom...)");
                        });

                        function writeToFile(data) {
                            var filename = parameters['filename'];
                            log("Write to " + filename);
                            try {
                                netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
                            } catch (e) {
                                alert("Permission to save file was denied.");
                                return;
                            }
                            var file = Components.classes["@mozilla.org/file/local;1"]
                                .createInstance(Components.interfaces.nsILocalFile);
                            file.initWithPath(filename);

                            // file is nsIFile, data is a string
                            var foStream = Components.classes["@mozilla.org/network/file-output-stream;1"]
                                .createInstance(Components.interfaces.nsIFileOutputStream);

                            // use 0x02 | 0x10 to open file for appending.
                            foStream.init(file, 0x02 | 0x08 | 0x20, 0666, 0); 
                            // write, create, truncate
                            // In a c file operation, we have no need to set file mode with or operation,
                            // directly using "r" or "w" usually.

                            // if you are sure there will never ever be any non-ascii text in data you can 
                            // also call foStream.writeData directly
                            var converter = Components.classes["@mozilla.org/intl/converter-output-stream;1"]
                                .createInstance(Components.interfaces.nsIConverterOutputStream);
                            converter.init(foStream, "UTF-8", 0, 0);
                            converter.writeString(data);
                            converter.close(); // this closes foStream
                            log("Done");
                        }

                        function log(msg) {
                                $('div#output div').prepend($('<br>'));
                                $('div#output div').prepend(msg);
                        }

                        var editing = false;

                        $(window).keydown(function(event) {
                                var li = $('li#selected');
                                if( !editing ) switch (event.keyCode ) {
                                    case 78:
                                        var la = li.next();
                                        if( la.length == 1 ) {
                                            li.removeAttr('id');
                                            la.attr('id', 'selected')
                                        }
                                        return false;
                                    case 82:
                                        var la = li.prev();
                                        if( la.length == 1 ) {
                                            li.removeAttr('id');
                                            la.attr('id', 'selected')
                                        }
                                        return false;
                                    case 84:
                                        var la = li.children().children().first();
                                        if( la.length > 0 ) {
                                            li.removeAttr('id');
                                            la.first().attr('id', 'selected');
                                        }
                                        return false;
                                    case 83:
                                        la = li.parents().first();
                                        if( la.attr('id') != 'tree' ) {
                                            li.removeAttr('id');
                                            la.parents().first().attr('id', 'selected');
                                        }
                                        return false;
                                    case 69:
                                        editing = true;
                                        var input = $('<input>').attr('name', 'subject').attr('type', 'text');
                                        var subject = li.children('span.subject').first().replaceWith(input);
                                        input.focus();
                                        input.val(subject.text());
                                        input.keydown(function(event) {
                                            switch( event.keyCode ) {
                                                case 27:
                                                    input.replaceWith(subject);
                                                    editing = false;
                                                    return false;
                                                case 13:
                                                    subject.text($(this).val());
                                                    $(this).replaceWith(subject);
                                                    editing = false;
                                                    return false;
                                                default:
                                                    return true;
                                            }
                                        });
                                        return false;
                                    case 72:
                                       li.toggleClass('headline'); 
                                       adjustSectioning(li);
                                       return false;
                                    case 65:
                                       var subject = li.children('span.subject').first();
                                       var body = li.children('div.body').first();
                                       var dlg = $('#editDialog');
                                       var textarea = $('#editDialog textarea');
                                       textarea.val(body.text());
                                       editing = true;
                                       dlg.dialog('option', {
                                           'title': subject.text(),
                                           'buttons':  {
                                               "Ok": function() {
                                                   body.text(textarea.val());
                                                   dlg.dialog('close');
                                               },
                                               "Cancel": function() {
                                                   dlg.dialog('close');
                                               }
                                       }});
                                       dlg.dialog('open');
                                       return false;
                                    case 88:
                                        $('div#output').toggleClass('hidden');
                                        return false;
                                    case 80:
                                        var str = "";
                                        str += "\\documentclass{srcartcl}\n";
                                        str += "\\begin{document}\n";
                                        str += generateOutput($('ul#tree'));
                                        str += "\\end{document}\n";
                                        writeToFile(str);
                                        return false;
                                    default:
                                        log(event.keyCode);
                                        return true;
                                }
                        });
                        var sectionsByDepth = [ 'section', 'subsection', 'subsubsection' ];
                        var sectionClasses = 'section subsection subsubsection';
                        function getHeadlineDepth(li) {
                            var depth = 0;
                            while( li.parents().first().attr('id') != 'tree' ) {
                                li = li.parents('li').first();
                                depth ++;
                            }
                            return depth;
                        }
                        function adjustSectioning(jq) {
                            jq.each(function(ix, li) {
                                li = $(li);
                                log('adjust ' + li.children('span').first().text());
                                li.removeClass(sectionClasses)
                                if( li.hasClass('headline') )
                                    li.addClass(sectionsByDepth[getHeadlineDepth(li)]);
                            });
                        };
                        function generateOutput(ul) {
                            var res = "";
                            ul.children('li').each(function(ix, li) {
                                li = $(li);
                                var subject = li.children('span.subject');
                                var body = li.children('div.body');
                                if( li.hasClass('headline') ) {
                                    var depth = getHeadlineDepth(li);
                                    res += "\\" + sectionsByDepth[depth] + "{" + subject.text() + "}"
                                } else
                                    res += "# " + subject.text();
                                res += "\n" + body.text() + "\n";
                                res += generateOutput(li.children(ul));
                            });
                            return res;
                        }
                        function repeatString(str, n) {
                            var res = ""
                            for(var i=0; i<n; i++) res += str;
                            return res;
                        }
                </script>
        </head>
        <body>
                <ul id='tree'>
                        <li class='headline'><span class='subject'>First section</span><div class='body'></div><ul>
                                        <li class='headline'>
                                            <span class='subject'>Prima section</span>
                                            <div class='body'></div></li>
                                        <li class='headline'>
                                            <span class='subject'>Seconda section</span>
                                            <div class='body'></div>
                                            <ul>
                                                    <li><span class='subject'>A section</span><div class='body'></div></li>
                                                    <li><span class='subject'>B section</span><div class='body'></div></li>
                                                    <li><span class='subject'>C section</span><div class='body'></div></li>
                                        </ul></li>
                                        <li class='headline'><span class='subject'>Tertia section</span><div class='body'></div></li>
                        </ul></li>
                        <li><span class='subject headline'>Second section</span> <div class='body'></div><ul>
                                <li><span class='subject'>A section</span><div class='body'></div></li>
                                <li><span class='subject'>B section</span><div class='body'></div></li>
                                <li><span class='subject'>C section</span><div class='body'></div></li>
                        </ul></li>
                        <li><span class='subject headline'>Third sectioni</span><div class='body'></div></li>
                </ul>
                <div id="output" class="hidden">
                        TODO
                        <ul>
                                <li>Hide items</li>
                                <li>Select multiple</li>
                                <li>Move items</li>
                                <li>Delete items</li>
                        </ul>
                        <div></div>
                </div>
                <div id="editDialog" title="Dialog Title"><textarea cols="82"></textarea></div>
        </body>
</html>
